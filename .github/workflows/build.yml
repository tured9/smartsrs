name: Build SmartSRS APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    # ========================================
    # Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ù‡Ù…Ø©: ØªØ«Ø¨ÙŠØª Android SDK
    # ========================================
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install Android SDK API 31
      run: |
        yes | sdkmanager --licenses || true
        sdkmanager "platforms;android-31"
        sdkmanager "build-tools;31.0.0"
        sdkmanager "platform-tools"
        echo "âœ… Android SDK API 31 installed"
    
    # ========================================
    # Cache Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡
    # ========================================
    - name: Cache Buildozer
      uses: actions/cache@v4
      with:
        path: |
          .buildozer
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
    
    # ========================================
    # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
    # ========================================
    - name: Install System Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev \
          cmake libffi-dev libssl-dev
    
    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install --upgrade Cython==0.29.33
        pip install --upgrade buildozer
    
    # ========================================
    # Ø¨Ù†Ø§Ø¡ APK
    # ========================================
    - name: Build APK
      run: |
        buildozer android debug
      env:
        ANDROID_HOME: /usr/local/lib/android/sdk
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
    
    # ========================================
    # Ø±ÙØ¹ APK
    # ========================================
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: SmartSRS-APK
        path: bin/*.apk
        retention-days: 30
    
    # ========================================
    # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª APK
    # ========================================
    - name: Show APK Info
      if: success()
      run: |
        echo "âœ… APK built successfully!"
        ls -lh bin/*.apk
        echo "ğŸ“¦ Download from Artifacts tab above"
